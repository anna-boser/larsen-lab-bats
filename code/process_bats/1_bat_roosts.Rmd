---
title: "Remove bat roost signal"
author: "Anna Boser"
date: "2022-10-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stars) # ʻstarsʻ requires 'sf' 0.9.8 was found, but >= 1.0.3
#library(raster)
library(sf)
library(terra)
library(exactextractr)
library(here)
library(splines)
library(ggplot2)
library(data.table)
```

## Remove the signal from the bat roosts

To remove the signal from the bat roosts, this notebook does the following: 
- creates an exponential model that predicts bat occurrence based on the proximity to a roost
- modifies this model to set predictions to zero if negative values are returned, since it does not make sense that there would be negative bat occurrence no matter how far you get from a roost. 
- subtracts this bat occurrence prediction from the original observed bat occurrence, to return the number of bats present correcting for the proximity to any roosts
- sets any negative values for corrected bat occurrence to 0, because it does not make sense to have negative bat occurrence. 


```{r}
# bat occurance data
bat_occ <- rast(here("data","aggregated_data", "2017_aggregate_2017.tif"))

# roost location
bat_roosts <- st_read(here("data", "ca_bat_roosts", "ca_colonies.shp")) %>% st_make_valid()
```

```{r}
# turn bat occurance data into a dataframe
bat_occ_df <- as.data.frame(bat_occ, xy=TRUE)
names(bat_occ_df) <- c("x", "y", "bats")

# x locations of roosts
x_roosts <- bat_roosts$xcoord

# y locations of roosts
y_roosts <- bat_roosts$ycoord
```

Here is some exploratory code to help decide if I want to use logistic or exponential curves: 
```{r}
# plot out the raw bat data

# ggplot() + 
#   geom_raster(data = bat_occ_df, aes(x=x, y=y, fill=bats)) + 
#   geom_point(data = bat_roosts, aes(x=xcoord, y=ycoord))
```


```{r}
# spline <- lm(formula = bats ~ bs(x, degree = 3, knots = x_roosts)*bs(y, degree = 3, knots = y_roosts) , data = bat_occ_df)
# bat_occ_df$spline <- spline$fitted.values
```

```{r}
# ggplot() + 
#   geom_raster(data = bat_occ_df, aes(x=x, y=y, fill=spline)) + 
#   geom_point(data = bat_roosts, aes(x=xcoord, y=ycoord))
```

```{r}
# Make a function that only keeps points that are within r from a point

# spot_filter <- function(d, x_center, y_center, r){
#   # first do a rough approximation 
#   d <- filter(d, x > x_center-r, x < x_center+r, y > y_center-r, y < y_center+r)
#   # then go over and get rid of the corners
#   d$dist = sqrt((d$x - x_center)^2+(d$y - y_center)^2)
#   d <- d[d$dist<r,]
#   return(d)
# }
# 
# d <- spot_filter(d=bat_occ_df, x_center=x_roosts[1], y_center=y_roosts[1], r=0.05)
```

```{r}
# ggplot(d) + 
#   geom_point(aes(x=dist, y=bats))
```

```{r}
# fit some exponential

# fit <- lm(log(bats) ~ log(dist), data = d)
# ggplot(d) + 
#   geom_point(aes(x=dist, y=bats)) + 
#   geom_line(aes(x=dist, y=exp(fit$fitted.values)), color = "red")
```

```{r}
# fit a logistic

# fit <- glm(bats/max(bats) ~ dist, family = "binomial", data = d)
# ggplot(d) + 
#   geom_point(aes(x=dist, y=bats)) + 
#   geom_line(aes(x=dist, y=fit$fitted.values*max(bats)), color = "red")
```

The exponential function wins. Now I need to code it up so that
1: I can get the exponential function for all 8 roosts
2: I can combine all of the regressions on the 3d plane

To combine all of the regressions, I:
1: separately calculate the predictions over the entire study area for each regression
2: add them together
3: subtract the result from the observed bats

Ok full step by step: 
1: add a column for distance to each roost to bat_occ_df
2: Fit a separate exponential function for each roost based on the closest 0.05 degrees
3: generate predictions for each roost regression. This is what the model predicts will be the bat occurrence based solely on its proximity to that one roost. 
4: add together the predictions for each roost regression. This is the number of bats that would be at any given spot given all of the roosts in the area
5: subtract the total roost regression from the bats. This is the number of total bats observed minus the bats that would be there simply due to the proximity to a roost. In other words, this is bat occurrence correcting for roosts. 
6: plot out the result

```{r}
# 1: add a column for distance to each roost to bat_occ_df
add_dist_col <- function(d, roost_num){
  x_center = bat_roosts$xcoord[roost_num]
  y_center = bat_roosts$ycoord[roost_num]
  d[paste0("dist", roost_num)] = sqrt((d$x - x_center)^2+(d$y - y_center)^2)
  return(d)
}

for (i in 1:nrow(bat_roosts)){
  bat_occ_df <- add_dist_col(bat_occ_df, i)
}
```

```{r}
# 2: Fit a separate logistic regression for each roost based on the closest 0.05 degrees
# and

# logistic_pred <- function(d, roost_num, r){
#   d['dist'] <- d[paste0("dist", roost_num)]
#   save <- d
#   d <- d[d['dist']<r,]
#   max_bats = max(d$bats)
#   fit <- glm(bats/max_bats ~ dist, family = "binomial", data = d)
#   
#   plot <- ggplot(d) + 
#     geom_point(aes(x=dist, y=bats)) + 
#     geom_line(aes(x=dist, y=fit$fitted.values*max_bats), color = "red") + 
#     ggtitle(paste("logistic", bat_roosts$xcoord[roost_num], bat_roosts$ycoord[roost_num]))
#   print(plot)
#   
#   save[paste0("logistic", roost_num)] <- predict(fit, save)*max_bats
#   return(save)
# }

# 2: Fit a separate exponential function for each roost based on the closest 0.05 degrees
# and

exponential_pred <- function(d, roost_num, r){
  d['dist'] <- d[paste0("dist", roost_num)]
  save <- d
  d <- d[d['dist']<r,]
  fit <- lm(log(bats + 1) ~ log(dist), data = d)
  
  plot <- ggplot(d) + 
    geom_point(aes(x=dist, y=bats)) + 
    geom_line(aes(x=dist, y=exp(fit$fitted.values)-1), color = "red") + 
    ggtitle(paste("exponential_r", r, "_", bat_roosts$xcoord[roost_num], bat_roosts$ycoord[roost_num]))
  print(plot)
  
  save[paste0("exponential_r", r, "_", roost_num)] <- exp(predict(fit, save))-1
  return(save)
}
```

```{r}
# 3: generate predictions for each roost function

# Logistic: 
# for (i in 1:nrow(bat_roosts)){
#   bat_occ_df <- logistic_pred(d=bat_occ_df, roost_num=i, r=0.05)
# }

# exponential:
for (i in 1:nrow(bat_roosts)){
  bat_occ_df <- exponential_pred(d=bat_occ_df, roost_num=i, r=0.05)
}
```

```{r}
# remove the pixels that are too close to the roost and therefore the exponential function will not work properly
far_from_roosts <- filter(bat_occ_df, 
                          dist1 > 0.01, 
                          dist2 > 0.01, 
                          dist3 > 0.01,
                          dist4 > 0.01,
                          dist5 > 0.01,
                          dist6 > 0.01,
                          dist7 > 0.01,
                          dist8 > 0.01)
```


```{r}
# 4: add together the predictions for each roost regression
# and 
# 5: subtract the total roost regression from the bats

corrected_pred <- function(d, func="logistic"){
  d[func] <- 0
  for (i in 1:nrow(bat_roosts)){
    d[func] <- d[func] + d[paste(func, i, sep = "_")]
  }
  d[func] = d[,func] - mean(d[,func]) # remove baseline bat presence from the model. 
  d[paste0(func, "_pred")] <- d["bats"] - d[func]
  return(d)
}

# bat_occ_df <- corrected_pred(bat_occ_df, func="logistic")
far_from_roosts <- corrected_pred(far_from_roosts, func="exponential_r0.05")
```

```{r}
# 6: plot out the result for logistic

# ggplot() + 
#   geom_raster(data = bat_occ_df, aes(x=x, y=y, fill=bats)) + 
#   geom_point(data = bat_roosts, aes(x=xcoord, y=ycoord)) + 
#   ggtitle("original_bats")
# 
# ggplot() + 
#   geom_raster(data = bat_occ_df, aes(x=x, y=y, fill=logistic)) + 
#   geom_point(data = bat_roosts, aes(x=xcoord, y=ycoord)) + 
#   ggtitle("logistic_predictions")
# 
# ggplot() + 
#   geom_raster(data = bat_occ_df, aes(x=x, y=y, fill=logistic_pred)) + 
#   geom_point(data = bat_roosts, aes(x=xcoord, y=ycoord)) + 
#   ggtitle("logistic_corrected_bats")

# 6: plot out results for exponential

ggplot() + 
  geom_raster(data = far_from_roosts, aes(x=x, y=y, fill=bats)) + 
  geom_point(data = bat_roosts, aes(x=xcoord, y=ycoord)) + 
  ggtitle("original bat occurance") + 
  scale_fill_distiller(palette="Spectral", direction = 1)

ggplot() + 
  geom_raster(data = far_from_roosts, aes(x=x, y=y, fill=exponential_r0.05)) + 
  geom_point(data = bat_roosts, aes(x=xcoord, y=ycoord)) + 
  ggtitle("exponential model of bat occurance based on proximity to roosts (0.01 degrees from roosts removed)") + 
  scale_fill_distiller(palette="Spectral", direction = 1)

ggplot() + 
  geom_raster(data = far_from_roosts, aes(x=x, y=y, fill=exponential_r0.05_pred)) + 
  geom_point(data = bat_roosts, aes(x=xcoord, y=ycoord)) + 
  ggtitle("Bat occurance corrected for roost precence using exponential model (0.01 degrees from roosts removed)") + 
  scale_fill_distiller(palette="Spectral", direction = 1)

```

There are two problems with the above plots. 
1) the exponential predictions (as in th exponential model predicts an average of negative bats) are negative on the edges, so we need to bump those up to zero
2) there are some negative bat predictions (that is number of bats minus exponential predictions) near the roosts, so we need to bump those up to zero

```{r}

ggplot() + 
  geom_raster(data = far_from_roosts, aes(x=x, y=y, fill=bats)) + 
  geom_point(data = bat_roosts, aes(x=xcoord, y=ycoord)) + 
  ggtitle("original bat occurance") + 
  scale_fill_distiller(palette="Spectral", direction = 1)

# first bump negative exponential predictions up to zero
far_from_roosts$exponential_noneg <- ifelse(far_from_roosts$exponential_r0.05<0, 0, far_from_roosts$exponential_r0.05)

ggplot() + 
  geom_raster(data = far_from_roosts, aes(x=x, y=y, fill=exponential_noneg)) + 
  geom_point(data = bat_roosts, aes(x=xcoord, y=ycoord)) + 
  ggtitle("exponential model predictions with negative predictions set to zero (0.01 degrees from roosts removed)") + 
  scale_fill_distiller(palette="Spectral", direction = 1)

# get new bat predictions
far_from_roosts$exp_corrected_bat_occ <- far_from_roosts$bats - far_from_roosts$exponential_noneg

ggplot() + 
  geom_raster(data = far_from_roosts, aes(x=x, y=y, fill=exp_corrected_bat_occ)) + 
  geom_point(data = bat_roosts, aes(x=xcoord, y=ycoord)) + 
  ggtitle("Roost corrected bat occurance (negative exponential model predictions set to 0) (0.01 degrees from roosts removed)") + 
  scale_fill_distiller(palette="Spectral", direction = 1)

# then bump negative bat predictions up to zero
far_from_roosts$final_occurrence_corrected <- ifelse(far_from_roosts$exp_corrected_bat_occ<0, 0, far_from_roosts$exp_corrected_bat_occ)

ggplot() + 
  geom_raster(data = far_from_roosts, aes(x=x, y=y, fill=final_occurrence_corrected)) + 
  geom_point(data = bat_roosts, aes(x=xcoord, y=ycoord)) + 
  ggtitle("Roost corrected bat occurance (negative values set to 0; negative exponential model predictions set to 0) (0.01 degrees from roosts removed)") + 
  scale_fill_distiller(palette="Spectral", direction = 1)
```


```{r}
library(raster)
# turn the corrected stuff back into a raster
r <- rasterFromXYZ(far_from_roosts[, c('x', 'y', 'final_occurrence_corrected')], crs = crs(bat_occ))

# save
writeRaster(r, here("data","bats_roost_adjusted", "bats_exponential_corrected_2017.tif"), overwrite = TRUE)
```

```{r}
# plot(rast(here("data","bats_roost_adjusted", "bats_exponential_corrected_2017.tif")))
```

